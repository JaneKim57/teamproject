import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="ì„œìš¸ì‹œ ìì „ê±°ë„ë¡œ ë¶„ì„", layout="wide")

# ë©”ì¸ ì†Œê°œ
st.title("ğŸš´ ì„œìš¸ì‹œ ìì „ê±°ë„ë¡œ ì¸í”„ë¼ ë° ë¶ˆê· í˜• ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
st.markdown("""
---
### ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš”
ì„œìš¸ì‹œ **ìì¹˜êµ¬ë³„ ì¸êµ¬**, **ë©´ì **, **ìì „ê±°ë„ë¡œ ê¸¸ì´** ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

1. ìì „ê±°ë„ë¡œ ì¸í”„ë¼ ë°€ë„ ë¶„ì„  
2. ì¸êµ¬ ëŒ€ë¹„ ìì „ê±°ë„ë¡œ ë¶ˆê· í˜• ì§€ìˆ˜ ë„ì¶œ  
   (ë¶ˆê· í˜• ì§€ìˆ˜ = ì¸êµ¬ë°€ë„ / ìì „ê±°ë„ë¡œ ë°€ë„)

---
### ğŸ§­ ì‚¬ìš© ë°©ë²•
- ì™¼ìª½ì—ì„œ ì§€í‘œì™€ ìì¹˜êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.
- ì•„ë˜ ì‹œê°í™”ì—ì„œ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
---
""")

@st.cache_data
def load_and_merge_data():
    # íŒŒì¼ ì´ë¦„: ì•±ê³¼ ê°™ì€ í´ë”ì— ìœ„ì¹˜í•´ì•¼ í•¨
    df_pop = pd.read_csv("ë“±ë¡ì¸êµ¬_ë™ë³„(2024).csv", encoding='utf-8').iloc[1:].copy()
    df_pop.columns = ['ìì¹˜êµ¬', 'í•­ëª©', 'ì¸êµ¬']
    df_pop = df_pop[df_pop['í•­ëª©'] == 'ê³„']
    df_pop['ì¸êµ¬'] = df_pop['ì¸êµ¬'].astype(int)

    df_area = pd.read_csv("í–‰ì •êµ¬ì—­_êµ¬ë³„(2024).csv", encoding='utf-8').iloc[2:].copy()
    df_area.columns = ['ì„œìš¸ì‹œ', 'ìì¹˜êµ¬', 'ë©´ì ']
    df_area['ë©´ì '] = df_area['ë©´ì '].astype(float)

    df_bike = pd.read_csv("ìì „ê±°ë„ë¡œ_í˜„í™©(2024).csv", encoding='utf-8').iloc[2:].copy()
    df_bike.columns = ['í•©ê³„', 'êµ¬ë¶„', 'ìì¹˜êµ¬', 'ìì „ê±°ë„ë¡œ_ê¸¸ì´']
    df_bike['ìì „ê±°ë„ë¡œ_ê¸¸ì´'] = df_bike['ìì „ê±°ë„ë¡œ_ê¸¸ì´'].astype(float)

    df = pd.merge(df_pop[['ìì¹˜êµ¬', 'ì¸êµ¬']], df_area[['ìì¹˜êµ¬', 'ë©´ì ']], on='ìì¹˜êµ¬')
    df = pd.merge(df, df_bike[['ìì¹˜êµ¬', 'ìì „ê±°ë„ë¡œ_ê¸¸ì´']], on='ìì¹˜êµ¬')

    df['ì¸êµ¬ë°€ë„'] = df['ì¸êµ¬'] / df['ë©´ì ']
    df['ìì „ê±°ë„ë¡œ_ë°€ë„'] = df['ìì „ê±°ë„ë¡œ_ê¸¸ì´'] / df['ë©´ì ']
    df['1ì¸ë‹¹_ìì „ê±°ë„ë¡œ'] = df['ìì „ê±°ë„ë¡œ_ê¸¸ì´'] / df['ì¸êµ¬']
    df['ë¶ˆê· í˜•_ì§€ìˆ˜'] = df['ì¸êµ¬ë°€ë„'] / df['ìì „ê±°ë„ë¡œ_ë°€ë„']

    # ìì¹˜êµ¬ ì¤‘ì‹¬ ìœ„ë„/ê²½ë„ (ê°„ë‹¨í•œ ìƒ˜í”Œ)
    gu_center = {
        'ì¢…ë¡œêµ¬': [37.5729, 126.9794], 'ì¤‘êµ¬': [37.5636, 126.9972], 'ìš©ì‚°êµ¬': [37.5323, 126.9906],
        'ì„±ë™êµ¬': [37.5633, 127.0364], 'ê´‘ì§„êµ¬': [37.5384, 127.0823], 'ë™ëŒ€ë¬¸êµ¬': [37.5744, 127.0396],
        'ì¤‘ë‘êµ¬': [37.6063, 127.0927], 'ì„±ë¶êµ¬': [37.5894, 127.0167], 'ê°•ë¶êµ¬': [37.6396, 127.0257],
        'ë„ë´‰êµ¬': [37.6688, 127.0472], 'ë…¸ì›êµ¬': [37.6554, 127.0775], 'ì€í‰êµ¬': [37.6176, 126.9227],
        'ì„œëŒ€ë¬¸êµ¬': [37.5791, 126.9368], 'ë§ˆí¬êµ¬': [37.5663, 126.9014], 'ì–‘ì²œêµ¬': [37.5175, 126.8664],
        'ê°•ì„œêµ¬': [37.5509, 126.8495], 'êµ¬ë¡œêµ¬': [37.4955, 126.8876], 'ê¸ˆì²œêµ¬': [37.4569, 126.8958],
        'ì˜ë“±í¬êµ¬': [37.5264, 126.8963], 'ë™ì‘êµ¬': [37.5124, 126.9392], 'ê´€ì•…êµ¬': [37.4784, 126.9516],
        'ì„œì´ˆêµ¬': [37.4836, 127.0326], 'ê°•ë‚¨êµ¬': [37.5172, 127.0473], 'ì†¡íŒŒêµ¬': [37.5145, 127.1059],
        'ê°•ë™êµ¬': [37.5302, 127.1238]
    }
    df['ìœ„ë„'] = df['ìì¹˜êµ¬'].map(lambda x: gu_center.get(x, [None, None])[0])
    df['ê²½ë„'] = df['ìì¹˜êµ¬'].map(lambda x: gu_center.get(x, [None, None])[1])

    return df

df = load_and_merge_data()

# ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.header("ğŸ”§ ë¶„ì„ ì¡°ê±´ ì„ íƒ")
indicator = st.sidebar.selectbox("ë¶„ì„ ì§€í‘œ", 
    ["ìì „ê±°ë„ë¡œ_ê¸¸ì´", "ìì „ê±°ë„ë¡œ_ë°€ë„", "1ì¸ë‹¹_ìì „ê±°ë„ë¡œ", "ì¸êµ¬ë°€ë„", "ë¶ˆê· í˜•_ì§€ìˆ˜"])
selected_gu = st.sidebar.multiselect("ìì¹˜êµ¬ í•„í„°", options=df['ìì¹˜êµ¬'].unique(), default=df['ìì¹˜êµ¬'].unique())

# í•„í„° ì ìš©
filtered_df = df[df['ìì¹˜êµ¬'].isin(selected_gu)]

# ë§‰ëŒ€ ê·¸ë˜í”„
st.subheader(f"ğŸ“Š {indicator} ë¹„êµ")
bar_fig = px.bar(filtered_df.sort_values(by=indicator, ascending=False),
                 x='ìì¹˜êµ¬', y=indicator, color=indicator)
st.plotly_chart(bar_fig, use_container_width=True)

# ì‚°ì ë„
st.subheader("âš–ï¸ ì¸êµ¬ë°€ë„ vs ìì „ê±°ë„ë¡œ ë°€ë„")
scatter_fig = px.scatter(filtered_df, x="ì¸êµ¬ë°€ë„", y="ìì „ê±°ë„ë¡œ_ë°€ë„",
                         size="1ì¸ë‹¹_ìì „ê±°ë„ë¡œ", color="ë¶ˆê· í˜•_ì§€ìˆ˜",
                         hover_name="ìì¹˜êµ¬")
st.plotly_chart(scatter_fig, use_container_width=True)

# ì§€ë„
st.subheader(f"ğŸ—ºï¸ ìì¹˜êµ¬ ì§€ë„ ì‹œê°í™”: {indicator}")
map_fig = px.scatter_mapbox(filtered_df, lat="ìœ„ë„", lon="ê²½ë„", size=indicator,
                            color=indicator, hover_name="ìì¹˜êµ¬",
                            mapbox_style="carto-positron", zoom=10, height=600)
st.plotly_chart(map_fig, use_container_width=True)
